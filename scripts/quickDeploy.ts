import { ethers } from "hardhat";
import fs from "fs";
import path from "path";

async function main() {
  console.log("ğŸš€ å¼€å§‹å¿«é€Ÿéƒ¨ç½² UniswapV2 åˆçº¦...");

  const [deployer] = await ethers.getSigners();
  console.log("éƒ¨ç½²è´¦æˆ·:", deployer.address);
  console.log("è´¦æˆ·ä½™é¢:", ethers.formatEther(await deployer.provider.getBalance(deployer.address)));

  // 1. éƒ¨ç½² WETH
  console.log("\nğŸ“¦ éƒ¨ç½² WETH...");
  const WETH = await ethers.getContractFactory("MockWETH");
  const weth = await WETH.deploy();
  await weth.waitForDeployment();
  const wethAddress = await weth.getAddress();
  console.log("âœ… WETH éƒ¨ç½²å®Œæˆ:", wethAddress);

  // 2. éƒ¨ç½² Factory
  console.log("\nğŸ“¦ éƒ¨ç½² UniswapV2Factory...");
  const Factory = await ethers.getContractFactory("UniswapV2Factory");
  const factory = await Factory.deploy(deployer.address);
  await factory.waitForDeployment();
  const factoryAddress = await factory.getAddress();
  console.log("âœ… Factory éƒ¨ç½²å®Œæˆ:", factoryAddress);

  // 3. éƒ¨ç½² Router
  console.log("\nğŸ“¦ éƒ¨ç½² UniswapV2Router02...");
  const Router = await ethers.getContractFactory("UniswapV2Router02");
  const router = await Router.deploy(factoryAddress, wethAddress);
  await router.waitForDeployment();
  const routerAddress = await router.getAddress();
  console.log("âœ… Router éƒ¨ç½²å®Œæˆ:", routerAddress);

  // 4. æ›´æ–°å‰ç«¯åœ°å€é…ç½®
  console.log("\nğŸ“ æ›´æ–°å‰ç«¯åœ°å€é…ç½®...");
  const addressesPath = path.join(__dirname, "../frontend/src/config/addresses.ts");
  
  const addressesContent = `// Contract addresses configuration
// Auto-generated by quickDeploy.ts

export interface ContractAddresses {
  factory: \`0x\${string}\`;
  router: \`0x\${string}\`;
  weth: \`0x\${string}\`;
}

// Default addresses for different networks
export const CONTRACT_ADDRESSES: Record<number, ContractAddresses> = {
  // Localhost (Anvil)
  31337: {
    factory: '${factoryAddress}' as \`0x\${string}\`,
    router: '${routerAddress}' as \`0x\${string}\`,
    weth: '${wethAddress}' as \`0x\${string}\`,
  },
  // Add other networks as needed
};

export function getContractAddresses(chainId: number): ContractAddresses | null {
  const addresses = CONTRACT_ADDRESSES[chainId];
  if (!addresses) {
    console.warn(\`Unsupported chain ID: \${chainId}\`);
    return null;
  }
  
  return addresses;
}
`;

  fs.writeFileSync(addressesPath, addressesContent);
  console.log("âœ… å‰ç«¯åœ°å€é…ç½®å·²æ›´æ–°");

  // 5. ä¿å­˜éƒ¨ç½²ä¿¡æ¯
  const deploymentInfo = {
    network: "localhost",
    chainId: 31337,
    deployer: deployer.address,
    contracts: {
      weth: wethAddress,
      factory: factoryAddress,
      router: routerAddress,
    },
    timestamp: new Date().toISOString(),
  };

  const deploymentPath = path.join(__dirname, "../deployment.json");
  fs.writeFileSync(deploymentPath, JSON.stringify(deploymentInfo, null, 2));
  console.log("âœ… éƒ¨ç½²ä¿¡æ¯å·²ä¿å­˜åˆ° deployment.json");

  console.log("\nğŸ‰ éƒ¨ç½²å®Œæˆï¼");
  console.log("ğŸ“‹ åˆçº¦åœ°å€:");
  console.log("   WETH:", wethAddress);
  console.log("   Factory:", factoryAddress);
  console.log("   Router:", routerAddress);
  console.log("\nğŸ’¡ ç°åœ¨æ‚¨å¯ä»¥åœ¨å‰ç«¯ä½¿ç”¨æ·»åŠ æµåŠ¨æ€§åŠŸèƒ½äº†ï¼");
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error("âŒ éƒ¨ç½²å¤±è´¥:", error);
    process.exit(1);
  }); 