# Init Code Hash å¯è§†åŒ–è§£é‡Š

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

**å¦‚ä½•åœ¨ä¸éƒ¨ç½²åˆçº¦çš„æƒ…å†µä¸‹ï¼Œæå‰çŸ¥é“åˆçº¦çš„åœ°å€ï¼Ÿ**

```
ä¼ ç»Ÿæ–¹å¼ (CREATE):
éƒ¨ç½²åˆçº¦ â†’ è·å¾—éšæœºåœ°å€ â†’ æ— æ³•é¢„æµ‹

CREATE2 æ–¹å¼:
è¾“å…¥ç¡®å®šå‚æ•° â†’ è®¡ç®—ç¡®å®šåœ°å€ â†’ å¯ä»¥é¢„æµ‹ï¼
```

## ğŸ§® CREATE2 åœ°å€è®¡ç®—å…¬å¼

```
åœ°å€ = keccak256(0xff + éƒ¨ç½²è€… + salt + initCodeHash)[12:]
```

### å‚æ•°è§£é‡Šï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CREATE2 åœ°å€è®¡ç®—                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0xff          â”‚ CREATE2 æ ‡è¯†ç¬¦ (å›ºå®šå€¼)                      â”‚
â”‚ éƒ¨ç½²è€…        â”‚ Factory åˆçº¦åœ°å€                             â”‚
â”‚ salt          â”‚ keccak256(token0 + token1)                  â”‚
â”‚ initCodeHash  â”‚ keccak256(UniswapV2Pair.creationCode)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Uniswap V2 æ‰§è¡Œæµç¨‹

### åœºæ™¯ï¼šç”¨æˆ·æƒ³è¦æ·»åŠ æµåŠ¨æ€§

```mermaid
graph TD
    A[ç”¨æˆ·è°ƒç”¨ addLiquidity] --> B[Router éœ€è¦ Pair åœ°å€]
    B --> C[Library.pairFor è®¡ç®—åœ°å€]
    C --> D[ä½¿ç”¨ CREATE2 å…¬å¼]
    D --> E[å¾—åˆ°é¢„è®¡ç®—åœ°å€]
    E --> F[æ£€æŸ¥è¯¥åœ°å€æ˜¯å¦æœ‰åˆçº¦]
    F --> G{Pair æ˜¯å¦å­˜åœ¨?}
    G -->|å¦| H[Factory.createPair]
    G -->|æ˜¯| I[ç›´æ¥ä½¿ç”¨ç°æœ‰ Pair]
    H --> J[ä½¿ç”¨ CREATE2 éƒ¨ç½²]
    J --> K[éƒ¨ç½²åœ°å€ = é¢„è®¡ç®—åœ°å€]
    I --> L[æ‰§è¡Œæ·»åŠ æµåŠ¨æ€§]
    K --> L
```

## ğŸ“Š å®é™…æ•°æ®æ¼”ç¤º

åŸºäºæˆ‘ä»¬çš„æ¼”ç¤ºè„šæœ¬ç»“æœï¼š

```
ğŸ­ Factory åœ°å€:     0x5FbDB2315678afecb367f032d93F642f64180aa3
ğŸª™ Token A:          0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512  
ğŸª™ Token B:          0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0

ğŸ“ è®¡ç®—è¿‡ç¨‹:
1ï¸âƒ£ æ’åºä»£å¸:
   token0 = 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0 (è¾ƒå°)
   token1 = 0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512 (è¾ƒå¤§)

2ï¸âƒ£ è®¡ç®— Salt:
   salt = keccak256(token0 + token1)
   = 0xc3b0d39761744182021d8af997620e6e165f9367a41749d68674580739a31e66

3ï¸âƒ£ Init Code Hash:
   = 0xd5d6b1b6f5b831abf9fef3ff763438b9b00975309b419df80a952304942cfbd4

4ï¸âƒ£ CREATE2 è®¡ç®—:
   åœ°å€ = keccak256(
     0xff +
     0x5FbDB2315678afecb367f032d93F642f64180aa3 +
     0xc3b0d39761744182021d8af997620e6e165f9367a41749d68674580739a31e66 +
     0xd5d6b1b6f5b831abf9fef3ff763438b9b00975309b419df80a952304942cfbd4
   )[12:]

ğŸ¯ ç»“æœ:
   é¢„è®¡ç®—åœ°å€: 0x85dede8fd2a5cc14925cbe61c57c68d1860f539e
   å®é™…åœ°å€:   0x85DEdE8FD2a5cC14925CBE61C57c68d1860F539E
   âœ… å®Œå…¨åŒ¹é…ï¼
```

## âš¡ ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

### ğŸš€ ä¼˜åŠ¿å¯¹æ¯”

| ä¼ ç»Ÿæ–¹å¼ (CREATE) | CREATE2 æ–¹å¼ |
|------------------|-------------|
| ğŸŒ å¿…é¡»å…ˆéƒ¨ç½²æ‰çŸ¥é“åœ°å€ | âš¡ å¯ä»¥é¢„å…ˆè®¡ç®—åœ°å€ |
| ğŸ’¸ æµªè´¹ Gasï¼ˆå¯èƒ½é‡å¤éƒ¨ç½²ï¼‰ | ğŸ’° èŠ‚çœ Gasï¼ˆæŒ‰éœ€éƒ¨ç½²ï¼‰ |
| ğŸ”„ éœ€è¦å¤šæ­¥æ“ä½œ | âš¡ å•æ­¥åŸå­æ“ä½œ |
| ğŸ˜• ç”¨æˆ·ä½“éªŒå·® | ğŸ˜Š ç”¨æˆ·ä½“éªŒå¥½ |

### ğŸ¯ å®é™…å¥½å¤„

1. **Gas æ•ˆç‡**ï¼š
   ```solidity
   // ä¸éœ€è¦è¿™æ ·åšï¼š
   address pair = factory.createPair(tokenA, tokenB);  // æ¶ˆè€— Gas
   // å¯ä»¥ç›´æ¥ï¼š
   address pair = Library.pairFor(factory, tokenA, tokenB);  // çº¯è®¡ç®—
   ```

2. **åŸå­æ€§**ï¼š
   ```solidity
   // ä¸€ä¸ªäº¤æ˜“å†…å®Œæˆï¼š
   function addLiquidity(...) {
       address pair = Library.pairFor(factory, tokenA, tokenB);  // è®¡ç®—åœ°å€
       if (factory.getPair(tokenA, tokenB) == address(0)) {
           factory.createPair(tokenA, tokenB);  // æŒ‰éœ€åˆ›å»º
       }
       // ç›´æ¥ä½¿ç”¨
       TransferHelper.safeTransferFrom(tokenA, msg.sender, pair, amountA);
   }
   ```

## âš ï¸ å¸¸è§é”™è¯¯

### ğŸš¨ Init Code Hash ä¸åŒ¹é…

```
âŒ é”™è¯¯åœºæ™¯:
Library ä¸­çš„ Hash: 0x1234...  (æ—§çš„æˆ–é”™è¯¯çš„)
å®é™… Pair çš„ Hash:  0xd5d6...  (å½“å‰æ­£ç¡®çš„)

ğŸ’¥ ç»“æœ:
é¢„è®¡ç®—åœ°å€: 0xf61e226ba8f0a1b2056bf897878b93035eedd02a
å®é™…åœ°å€:   0x85DEdE8FD2a5cC14925CBE61C57c68d1860F539E

ğŸ”¥ é”™è¯¯ä¿¡æ¯:
"function call to a non-contract account"
```

### ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

1. **é‡æ–°è®¡ç®— Hash**ï¼š
   ```javascript
   const Pair = await ethers.getContractFactory("UniswapV2Pair");
   const initCodeHash = ethers.keccak256(Pair.bytecode);
   ```

2. **æ›´æ–° Library**ï¼š
   ```solidity
   // åœ¨ UniswapV2Library.sol ä¸­æ›´æ–°
   hex'd5d6b1b6f5b831abf9fef3ff763438b9b00975309b419df80a952304942cfbd4'
   ```

## ğŸ“ å­¦ä¹ è¦ç‚¹

1. **Init Code Hash æ˜¯ä»€ä¹ˆ**ï¼š
   - Pair åˆçº¦åˆ›å»ºå­—èŠ‚ç çš„ keccak256 å“ˆå¸Œå€¼
   - ç”¨äº CREATE2 åœ°å€è®¡ç®—çš„å…³é”®å‚æ•°

2. **ä¸ºä»€ä¹ˆéœ€è¦å®ƒ**ï¼š
   - å®ç°ç¡®å®šæ€§åœ°å€è®¡ç®—
   - æé«˜ Gas æ•ˆç‡å’Œç”¨æˆ·ä½“éªŒ
   - æ”¯æŒåŸå­æ€§æ“ä½œ

3. **å¦‚ä½•ä¿æŒæ­£ç¡®**ï¼š
   - æ¯æ¬¡ä¿®æ”¹ Pair åˆçº¦åé‡æ–°è®¡ç®—
   - åœ¨éƒ¨ç½²å‰éªŒè¯ Hash çš„æ­£ç¡®æ€§
   - ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬æ£€æŸ¥ä¸€è‡´æ€§

4. **è®¾è®¡å“²å­¦**ï¼š
   - è¿™æ˜¯ CREATE2 çš„ç»ä½³åº”ç”¨æ¡ˆä¾‹
   - å±•ç¤ºäº†å¦‚ä½•ç”¨å¯†ç å­¦è§£å†³å·¥ç¨‹é—®é¢˜
   - ä½“ç°äº† DeFi åè®®çš„ç²¾å·§è®¾è®¡

## ğŸ”— ç›¸å…³æ¦‚å¿µ

- **CREATE2 æ“ä½œç **ï¼šä»¥å¤ªåŠçš„ç¡®å®šæ€§åˆçº¦éƒ¨ç½²
- **Factory æ¨¡å¼**ï¼šç»Ÿä¸€ç®¡ç†åˆçº¦åˆ›å»º
- **Salt æœºåˆ¶**ï¼šç¡®ä¿ä¸åŒè¾“å…¥äº§ç”Ÿä¸åŒåœ°å€
- **å­—èŠ‚ç å“ˆå¸Œ**ï¼šåˆçº¦ä»£ç çš„å”¯ä¸€æ ‡è¯†

è¿™ç§è®¾è®¡ä¸ä»…åœ¨ Uniswap V2 ä¸­ä½¿ç”¨ï¼Œä¹Ÿè¢«è®¸å¤šå…¶ä»– DeFi åè®®é‡‡ç”¨ï¼Œæ˜¯ç°ä»£æ™ºèƒ½åˆçº¦æ¶æ„çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚ 